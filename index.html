<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Quiz Battle - Kantor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Inline favicon biar ga 404 -->
    <link
      rel="icon"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJ
    bWFnZVJlYWR5ccllPAAAAA9QTFRFAAAA////AAAA////AAAA////AAAA////AAAA////AAAA////
    AAAA////AAAA////AAAA////AAAA////AAAA////8n0C9QAAAAV0Uk5T/////wD7tg5TAAAAK0lE
    QVQY02NgYGBgYGBgZGBgYGD4//8/AwPD////PwMDAwMDAwMAAAcQBBgA6Q0FkgAAAABJRU5ErkJg
    gg=="
    />

    <!-- Styles eksternal -->
    <link rel="stylesheet" href="./styles.css" />

    <!-- Firebase (modular) -->
    <script type="module">
      async function loadFirebaseConfig() {
        try {
          const resp = await fetch("./firebase-config.json");
          if (!resp.ok) throw new Error("config not found");
          return await resp.json();
        } catch (e) {
          return null;
        }
      }

      const externalConfig = await loadFirebaseConfig();

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref as r,
        push as p,
        set as s,
        update as u,
        get as g,
        onValue as ov,
        child as ch,
        serverTimestamp as st,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      let initialized = false;

      function initFirebase(cfg) {
        if (initialized) return;
        const configToUse = cfg || externalConfig;
        if (!configToUse) return;
        try {
          const app = initializeApp(configToUse);
          const db = getDatabase(app);
          window.fb = {
            db,
            ref: (path) => r(db, path),
            push: (refArg) => p(refArg),
            set: (refArg, val) => s(refArg, val),
            update: (refArg, val) => u(refArg, val),
            get: (refArg) => g(refArg),
            onValue: (refArg, cb) => ov(refArg, cb),
            child: (refArg, key) => ch(refArg, key),
            serverTimestamp: () => st(),
          };
          initialized = true;
        } catch (e) {
          console.error("Firebase init failed", e);
        }
      }

      if (externalConfig) initFirebase(externalConfig);

      window.initFirebase = function (cfg) {
        initFirebase(cfg);
      };
    </script>
  </head>

  <body>
    <div class="container">
      <div class="card" id="roleCard">
        <h1>ğŸ† Quiz Battle Edisi Morning Briefing BTECH</h1>
        <p>Pilih peran kamu:</p>
        <div class="role-select">
          <button class="btn-primary" onclick="selectHostRole()">Saya Host</button>
          <button class="btn-secondary" onclick="selectRole('player')">Saya Peserta</button>
        </div>
        <p class="small">
          Host buka ini di laptop &amp; share layar. Peserta buka link yang sama di HP.
        </p>
      </div>

      <!-- Host password modal -->
      <div
        id="hostPasswordModal"
        class="modal hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="hostPasswordTitle"
      >
        <div class="modal-overlay" onclick="closeHostPasswordModal()"></div>
        <div class="modal-content" role="document">
          <h3 id="hostPasswordTitle">Masuk sebagai Host</h3>
          <p class="small">Masukkan password untuk masuk sebagai host.</p>
          <input
            id="hostPasswordInput"
            type="password"
            autocomplete="current-password"
            placeholder="Password"
            class="modal-input"
          />
          <div class="modal-actions">
            <button class="btn-primary" onclick="submitHostPassword()">Masuk</button>
            <button class="btn-secondary" onclick="closeHostPasswordModal()">Batal</button>
          </div>
          <p id="hostPasswordError" class="small modal-error" style="display:none;"></p>
        </div>
      </div>

      <!-- HOST VIEW -->
      <div id="hostView" class="hidden">
        <div class="card">
          <div class="host-header">
            <h2>ğŸ‘‘ Host Panel</h2>
            <button class="btn-secondary" onclick="goToRoleSelection()">Kembali</button>
          </div>

          <!-- Lobby / Create -->
          <div id="hostLobbySection" class="host-section">
            <div class="host-section-header">
              <span>Lobby / Create</span>
              <button
                class="host-section-toggle"
                onclick="toggleHostSection('hostLobbySection')"
              >
                <span class="toggle-icon">â–¼</span>
              </button>
            </div>
            <div class="host-section-body">
              <p>Status: <span class="badge" id="hostStatusBadge">Belum mulai</span></p>
              <button class="btn-primary" onclick="createGame()">Buat Game Baru</button>

              <div class="host-resume-wrapper">
                <input
                  type="text"
                  id="hostResumePinInput"
                  placeholder="PIN untuk lanjutkan game"
                />
                <button class="btn-secondary" onclick="tryResumeGame()">Lanjutkan Game</button>
                <p class="small" id="hostResumeError"></p>
              </div>
              <p class="small">Klik "Buat Game Baru" lalu share PIN ke peserta.</p>
            </div>
          </div>

          <!-- Game Info -->
          <div id="hostGameInfo" class="hidden host-section">
            <div class="host-section-header">
              <span>Game Info</span>
              <button
                class="host-section-toggle"
                onclick="toggleHostSection('hostGameInfo')"
              >
                <span class="toggle-icon">â–¼</span>
              </button>
            </div>
            <div class="host-section-body">
              <p>PIN Game:</p>
              <div class="pin-code" id="gamePinDisplay">----</div>
              <p class="small">
                Peserta masuk ke: <strong>link ini</strong> lalu masukkan PIN dan nama.
              </p>
              <p><strong>Peserta bergabung:</strong></p>
              <div id="playersList"></div>

              <div class="host-game-actions">
                <button class="btn-primary" onclick="startGame()">Mulai Quiz</button>
                <button class="btn-secondary" onclick="endGame()">Akhiri Game</button>
              </div>
            </div>
          </div>

          <!-- Questions & Controls -->
          <div id="hostQuestionCard" class="host-section hidden">
            <div class="host-section-header">
              <span>Questions &amp; Controls</span>
              <button
                class="host-section-toggle"
                onclick="toggleHostSection('hostQuestionCard')"
              >
                <span class="toggle-icon">â–¼</span>
              </button>
            </div>
            <div class="host-section-body">
              <div class="flex host-question-header">
                <div>
                  <h3 id="hostQuestionTitle">Pertanyaan</h3>
                  <p class="small">
                    No. <span id="questionIndexLabel"></span> dari
                    <span id="questionTotalLabel"></span>
                  </p>
                </div>
                <div class="host-status-timer">
                  <div>
                    <span class="pill">
                      Status: <span id="hostGamePhaseLabel">Lobby</span>
                    </span>
                  </div>
                  <div class="timer-label">
                    â± <span id="hostTimerLabel">10.0s</span>
                  </div>
                  <div class="host-countdown">
                    <span class="small">
                      Mulai dalam:
                      <strong><span id="hostCountdownLabel">10.0s</span></strong>
                    </span>
                  </div>
                </div>
              </div>

              <div class="question-image" id="hostQuestionImage" style="display:none;"></div>
              <p id="hostQuestionText"></p>
              <div class="options-grid" id="hostOptionsContainer"></div>

              <div class="host-question-actions">
                <button class="btn-primary" onclick="nextQuestion()">Next Question</button>
                <button class="btn-secondary" onclick="revealAnswer()">
                  Reveal Answer &amp; Score
                </button>
              </div>

              <div class="host-leaderboard">
                <h4>Leaderboard</h4>
                <div id="hostLeaderboard"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PLAYER VIEW -->
      <div id="playerView" class="hidden">
        <!-- Join card -->
        <div class="card" id="playerJoinCard">
          <h2>ğŸ™‹ Masuk sebagai Peserta</h2>
          <input type="text" id="playerNameInput" placeholder="Nama kamu" />

          <div>
            <p class="small">Pilih ikon profil:</p>
            <div class="avatar-grid" id="avatarPicker">
              <button
                class="avatar-btn"
                data-avatar="ğŸ˜€"
                onclick="selectPlayerAvatar('ğŸ˜€', this)"
              >
                ğŸ˜€
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ˜"
                onclick="selectPlayerAvatar('ğŸ˜', this)"
              >
                ğŸ˜
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¦Š"
                onclick="selectPlayerAvatar('ğŸ¦Š', this)"
              >
                ğŸ¦Š
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ±"
                onclick="selectPlayerAvatar('ğŸ±', this)"
              >
                ğŸ±
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¼"
                onclick="selectPlayerAvatar('ğŸ¼', this)"
              >
                ğŸ¼
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¤–"
                onclick="selectPlayerAvatar('ğŸ¤–', this)"
              >
                ğŸ¤–
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¸"
                onclick="selectPlayerAvatar('ğŸ¸', this)"
              >
                ğŸ¸
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ—¿"
                onclick="selectPlayerAvatar('ğŸ—¿', this)"
              >
                ğŸ—¿
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¶"
                onclick="selectPlayerAvatar('ğŸ¶', this)"
              >
                ğŸ¶
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¦"
                onclick="selectPlayerAvatar('ğŸ¦', this)"
              >
                ğŸ¦
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¯"
                onclick="selectPlayerAvatar('ğŸ¯', this)"
              >
                ğŸ¯
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¤ª"
                onclick="selectPlayerAvatar('ğŸ¤ª', this)"
              >
                ğŸ¤ª
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¥¸"
                onclick="selectPlayerAvatar('ğŸ¥¸', this)"
              >
                ğŸ¥¸
              </button>
              <button
                class="avatar-btn"
                data-avatar="ğŸ¤¡"
                onclick="selectPlayerAvatar('ğŸ¤¡', this)"
              >
                ğŸ¤¡
              </button>
            </div>

            <div class="avatar-url-row">
              <input
                id="avatarUrlInput"
                placeholder="Paste your own image URL"
                class="avatar-url-input"
              />
              <button class="btn-secondary" onclick="useAvatarUrl()">Gunakan</button>
              <div id="avatarPreview" class="avatar-preview">?</div>
            </div>
          </div>

          <input type="text" id="pinInput" placeholder="PIN Game" />
          <button class="btn-primary" onclick="joinGame()">Gabung</button>
          <p class="small" id="playerJoinError"></p>
        </div>

        <!-- Waiting card -->
        <div class="card hidden" id="playerWaitingCard">
          <h3>Menunggu mulai...</h3>
          <p>Hai, <span id="playerNameLabel"></span> ğŸ‘‹</p>
          <p>PIN Game: <strong id="playerGamePinLabel"></strong></p>
          <p class="small">Host akan segera memulai quiz.</p>
          <p class="small">
            Dimulai dalam:
            <strong><span id="playerCountdownLabel">10.0s</span></strong>
          </p>
          <div class="player-actions">
            <button class="btn-secondary" onclick="confirmAndJoinAnotherGame()">
              Gabung game lain
            </button>
            <button class="btn-secondary" onclick="goToRoleSelection()">Kembali</button>
          </div>
        </div>

        <!-- Question card -->
        <div class="card hidden" id="playerQuestionCard">
          <div class="flex player-question-header">
            <div>
              <h3 id="playerQuestionText"></h3>
              <p class="small">
                Pertanyaan ke-<span id="playerQuestionIndexLabel"></span>
              </p>
            </div>
            <div class="timer-label">
              â± <span id="playerTimerLabel">10.0s</span>
            </div>
          </div>

          <div class="question-image" id="playerQuestionImage" style="display:none;"></div>
          <div class="options-grid" id="playerOptionsContainer"></div>
          <p class="small" id="playerStatusLabel"></p>
          <p class="small" id="playerGainLabel"></p>
          <p class="small" id="playerTotalScoreLabel"></p>
          <div class="player-actions">
            <button class="btn-secondary" onclick="confirmAndJoinAnotherGame()">
              Gabung game lain
            </button>
            <button class="btn-secondary" onclick="goToRoleSelection()">Kembali</button>
          </div>
        </div>

        <!-- Summary card -->
        <div class="card hidden" id="playerSummaryCard">
          <h2>ğŸ‰ Selesai!</h2>
          <p>
            Skor kamu:
            <strong><span id="playerFinalScore"></span></strong>
          </p>
          <p class="small">Terima kasih sudah bermain ğŸ™Œ</p>
          <div class="player-actions">
            <button class="btn-primary" onclick="joinAnotherGame()">Gabung game lain</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./questions.js"></script>
    <script src="./main.js"></script>
  </body>
</html>
